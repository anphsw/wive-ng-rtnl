#!/bin/sh

#get params
. /sbin/global.sh
. /sbin/config.sh

#wait to start web and run from goahead code
web_wait

LOG="echo WAN: "

start() {
 $LOG "Start wan config"

    get_param

    #set variable
    UDHCPCOPTS="-r -S -R -T 10 -A 30 -s /sbin/udhcpc.sh -p /var/run/udhcpc.pid -O routes staticroutes msroutes -f &"

    #stop dhcp client
    killall -q udhcpc
    killall -q -9 udhcpc

    #set force renew marker
    touch /var/tmp/is_up/force_renew

    /bin/hostname $HOSTNAME
    echo "127.0.0.1	localhost $HOSTNAME.lo" > /etc/hosts
    echo "$lan_ip	$HOSTNAME.lo" >> /etc/hosts
    echo "$wan_ip		$HOSTNAME.lo" >> /etc/hosts

    #Only Ethernet converter support MAC Clone
    if [ "$opmode" = "2" ] && [ "$clone_en" = "1" ] && [ "$clone_mac" != "" ]; then
	#reload wifi modules
	service modules restart
    fi

    if [ "$wanmode" = "STATIC" ] || [ "$opmode" = "0" ]; then
	if [ "$opmode" != "0" ]; then
	    #lan and wan ip should not be the same except in bridge mode
	    if [ "$wan_ip" = "$lan_ip" ]; then
		$LOG "wan service: warning: WAN's IP address is set identical to LAN"
		exit 0
	    fi
	    #wan interface up and default gateway
	    ifconfig $wan_if $wan_ip netmask $wan_nm
	    #always treat bridge mode having static wan connection
	    #route mode
	    if [ "$gw" != "" ] && [ "$gw" != "0.0.0.0" ]; then
		ip route replace default via $gw
	    fi
	else
	    #wan interface up and default gateway
	    ifconfig br0 $lan_ip netmask $lan_nm
	    #if bridge mode dgw on dev br0 set
    	    ip route replace default dev br0
        fi

    elif [ "$wanmode" = "DHCP" ]; then
	udhcpc -i $wan_if -H $HOSTNAME $UDHCPCOPTS > /dev/null 2>&1 &
    else
	$LOG "wan service: unknown wan connection type: $wanmode"
	exit 1
    fi

    #check pppd or xl2tpd started
    PPP_STARTED=`pidof pppd`
    XL2TPD_STARTED=`pidof xl2tpd`

    if [ "$vpnEnabled" = "on" ] && [ "$PPP_STARTED" = "" ] && [ "$XL2TPD_STARTED" = "" ]; then
    	    (sleep 20 && service vpnhelper restart) &
    fi
}

stop() {
 $LOG " "
}

get_param() {
    #get parametrs
    clone_en=`nvram_get 2860 macCloneEnabled`
    clone_mac=`nvram_get 2860 macCloneMac`
    wan_ip=`nvram_get 2860 wan_ipaddr`
    wan_nm=`nvram_get 2860 wan_netmask`
    lan_ip=`nvram_get 2860 lan_ipaddr`
    lan_nm=`nvram_get 2860 lan_netmask`
    wanmode=`nvram_get 2860 wanConnectionMode`
    gw=`nvram_get 2860 wan_gateway`
    vpnEnabled=`nvram_get 2860 vpnEnabled`
}

case "$1" in
	start)
	    start
	    ;;

	stop)
	    stop
	    ;;

	restart)
	    stop
	    start
	    ;;

	*)
	    echo $"Usage: $0 {start|stop|restart}"
	    exit 1
esac
