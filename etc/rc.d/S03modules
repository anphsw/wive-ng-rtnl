#!/bin/sh

#get params                                                                                                                                 
. /etc/scripts/global.sh

LOG="echo MODULES: "

start() {
    #if goahead not started
    if [ ! -f /tmp/webrun ]; then
	if [ ! -f /etc/modules.dep ]
	    $LOG "Start modules.dep generate..."
	    depmod -a -n >  /etc/modules.dep
	fi
	$LOG "Check nvram..."
	check_nvram
    else
	$LOG "Prepare wifi config..."
	get_param
	gen_wifi_config
	if [ "$WMAC" != "" ]; then
	    mac="mac=$WMAC"
	else
	    mac=
	fi
	$LOG "Load wifi module..."
	if [ "$opmode" = "2" ] && [ "$clone_en" = "1" ] && [ "$clone_mac" != "" ]; then
	    $LOG "Macclone mode. Mac is $clone_mac"
	    modprobe -q rt2860v2_sta mac=$clone_mac
	else
	    $LOG "Normal mode. Sta mode $stamode"
    	    if [ "$stamode" = "y" ]; then
    		modprobe -q rt2860v2_sta "$mac"
		ifconfig ra0 hw ether $WMAC
	    else
    		modprobe -q rt2860v2_ap "$mac"
		ifconfig ra0 hw ether $WMAC
	    fi
	fi
	$LOG "link wifi up second"
	ip link set ra0 up > /dev/null 2>&1
	ra0flushadress
    fi
}

stop() {
    if [ ! -f /tmp/webrun ]; then
        $LOG "Stop modules.dep generate..."
    else
	$LOG "link wifi down first"
	ra0flushadress
	ip link set ra0 down > /dev/null 2>&1
        $LOG "Unload wifi module..."
	rmmod rt2860v2_ap > /dev/null 2>&1
	rmmod rt2860v2_sta > /dev/null 2>&1
    fi
}

ra0flushadress()
{
    #flush adresses
    ip addr flush dev ra0  > /dev/null 2>&1
    if [ "$CONFIG_IPV6" != "" ] ; then
        ip -6 addr flush dev ra0 > /dev/null 2>&1
    fi
}

get_param() {
	clone_en=`nvram_get 2860 macCloneEnabled`
	clone_mac=`nvram_get 2860 macCloneMac`
	WMAC=`nvram_get WLAN_MAC_ADDR`
}

gen_wifi_config()
{
	rm -rf /etc/Wireless/RT2860/RT2860.dat
	ralink_init make_wireless_config rt2860
}

check_nvram()
{
    #check firmwave update or clean burn
    IS_WIVE=`nvram_get 2860 IS_WIVE`
    if [ "$IS_WIVE" = "YES" ]; then
	$LOG "Normal boot no need reset"
    else
	$LOG "Clear and load defaults to nvram!"
	fs nvramreset
	nvram_set 2860 IS_WIVE YES
	touch /var/MODIFIED
	$LOG "Reset OK... boot..."
    fi
}

case "$1" in
	ra0flushadress)
	    ra0flushadress
	    ;;

	start)
	    start
	    ;;

	stop)
	    stop
	    ;;

	restart)
	    stop
	    start
	    ;;

	*)
	    echo $"Usage: $0 {start|stop|restart|ra0flushadress}"
	    exit 1
esac
