#!/bin/sh

#include kernel config
. /etc/scripts/config.sh

#only clean load start this
if [ -f /var/run/goahead.pid ]; then
    exit 0
fi

LOG="echo PRECONFIG: "

start() {
 $LOG "Preconfigure..."
    export PATH=.:$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/etc/scripts

    $LOG "Delete old config"
    rm -f /etc/zebra.conf
    rm -f /etc/ripd.conf
    rm -f /etc/macipfilter
    rm -f /etc/websfilter
    rm -f /etc/portforward
    rm -f /etc/ppp_firewall
    rm -f /etc/resolv_conf.bak

    $LOG "Mount all filesystems"
    mount -a
    mount -t devpts /dev/pts /dev/pts
    mknod /dev/ptmx c 5 2
    
    $LOG "Create some folders"
    mkdir -p /var/run
    mkdir -p /var/lock
    mkdir -p /var/lock/subsys
    mkdir -p /var/log
    mkdir -p /var/tmp
    mkdir -p /var/run/xl2tpd
    mkdir -p /etc/ppp/ip-up.d
    mkdir -p /etc/ppp/ip-down.d

    mkdir -p /dev/pty
    for i in `seq 0 15`; do
	mknod /dev/pty/m$i c 2 $i
    done

    mkdir -p /dev/tts
    mknod /dev/tts/0              c       4       64
    mknod /dev/tts/1              c       4       65

    mkdir -p /dev/cua
    mknod /dev/cua/0              c       5       64

    mkdir -p /dev/misc
    mknod /dev/misc/rtc   c       10      135

    #modify permissions
    chmod 777 /tmp

    #ralink depended
    mknod /dev/flash0 c 200 0
    mknod /dev/hwnat0 c 220 0
    mknod /dev/swnat0 c 210 0

    mknod /dev/i2cM0 c 218 0
    mknod /dev/I2S c 234 0
    mknod /dev/ac0 c 240 0
    mknod /dev/acl0 c 230 0
    mknod /dev/aci0 c 254 0
    mknod /dev/aci1 c 254 1
    mknod /dev/aci2 c 254 2
    mknod /dev/aci3 c 254 3
    mknod /dev/gpio c 252 0
    mknod /dev/gpio0 c 252 0
    mknod /dev/gpio1 c 252 1

    mknod /dev/rdm0 c 254 0
    mknod /dev/PCM c 233 0
    mknod /dev/spiS0 c 217 0
    mknod /dev/spi0 c 153 0
    mknod /dev/spi1 c 153 1
    mknod /dev/spi2 c 153 2
    mknod /dev/spi3 c 153 3

#if compile date fille is exist
if [ -f /etc/compile-date ]; then
    $LOG "Restore time to build time or save time"
    BUILDDATE=`cat /etc/compile-date`
    if [ "$BUILDDATE" != "" ]; then
	date -s $BUILDDATE
    fi
fi

if [ `cat /proc/meminfo | awk '/MemTotal:/ {print ($2>16384)}'` -eq 1 ]; then
    $LOG "Copy web pages to tmpfs"
    mkdir -p /tmp/web
    cp -rpf /web/* /tmp/web
else
    $LOG "16M device detected, creating symlink for web pages in tmpfs"
    ln -s /web /tmp/web
fi

}

stop() {
 echo "" > /dev/null
}

case "$1" in
	start)
	    start
	    ;;

	stop)
	    stop
	    ;;

	restart)
	    stop
	    start
	    ;;

	*)
	    echo $"Usage: $0 {start|stop|restart}"
	    exit 1
esac
