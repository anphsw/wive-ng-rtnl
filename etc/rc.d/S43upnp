#!/bin/sh

#get params
. /sbin/global.sh

#wait to start web and run from goahead code
web_wait

start() {
if [ -f /bin/miniupnpd ]; then
 get_param
    if [ "$opmode" = "0" ] || [ "$opmode" = "1" ] || [ "$vpnEnabled" = "on" ]; then
	EXTIP="`LC_ALL=C /sbin/ifconfig $wan_upnp_if 2>&1 | grep 'inet addr' | awk '{print $2}' | sed -e 's/.*://'`"
        if [ "$upnp" = "1" ] && [ "$EXTIP" != "" ]; then
	  echo "Start upnp "
	    echo "External IP = $EXTIP"
            route add -net 239.0.0.0 netmask 255.0.0.0 dev $lan_if
	    cat /etc/miniupnpd.conf.template > /etc/miniupnpd.conf 
	    cat /etc/miniupnpd.conf.uuid >> /etc/miniupnpd.conf 
            miniupnpd -f /etc/miniupnpd.conf -i $wan_upnp_if -o $EXTIP -a $ip &
	fi
    fi
fi
}

stop() {
 echo "Stop upnp "
    killall -q miniupnpd
    route del -net 239.0.0.0 netmask 255.0.0.0 dev $lan_if > /dev/null 2>&1
}

get_param() {
    ip=`nvram_get 2860 lan_ipaddr`
    upnp=`nvram_get 2860 upnpEnabled`
    vpnEnabled=`nvram_get 2860 vpnEnabled`
    if [ "$vpnEnabled" = "on" ]; then
	wan_upnp_if="ppp0"
    else
	if [ "$wan_if" = "" ]; then
	    wan_upnp_if="eth2.2"
	else
	    wan_upnp_if=$wan_if
        fi
    fi
}


case "$1" in
	start)
	    start
	    ;;

	stop)
	    stop
	    ;;

	restart)
	    stop
	    start
	    ;;

	*)
	    echo $"Usage: $0 {start|stop|restart}"
	    exit 1
esac
