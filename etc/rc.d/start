#!/bin/sh

# Start all init scripts in /etc/rc.d
# executing them in numerical order.

LOG="echo INIT: "

tmpfs_av=`cat /proc/filesystems | grep tmpfs -c`
if [ "$tmpfs_av" != "0" ]; then
    #mount /tmp /etc in /var
    mkdir -p /var/tmpfs
    mount -o bind /var/tmpfs /tmp
    #make dir for rwfs
    mkdir -p /var/rwfs
    mount -o bind /var/rwfs /etc
fi

TGZfs_size=131072
BLOCKS=2
MTDDEVICE=/dev/mtdblock5
ROOTDEVICE=/dev/mtdblock4

get_size(){
  ls -sk $1 |  sed -e "s/ \+/ /g" | cut -d" " -f2
}

$LOG "Prepare start init!"
export PATH=.:$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/etc/scripts

$LOG "Init DEV particion"
zcat /dev.gz | /bin/tar xf - -C / > /dev/null 2>&1

$LOG "Init RW particion"
zcat $MTDDEVICE | /bin/tar xf - -C / > /dev/null 2>&1

if [ -f /etc/filesystem.ok ] && [ -f /etc/rc.d/rcS ]; then
    $LOG "RW File system is ok - preparing ..."
  else
    mkdir /tmp/rootfs
    mount $ROOTDEVICE /tmp/rootfs -o ro
    $LOG "File system is clear or poor."
    cp -a /tmp/rootfs/etc/* /etc
    umount /tmp/rootfs
    rm -rf /tmp/rootfs
    $LOG "Restored. Save after full boot and configure."
    touch /etc/filesystem.ok
fi

$LOG "Start init now."
/bin/sh /etc/rc.d/rcS &
