#!/bin/sh

# Start all init scripts in /etc/rc.d
# executing them in numerical order.

TGZfs_size=131072
BLOCKS=2
MTDDEVICE=/dev/mtdblock5
ROOTDEVICE=/dev/mtdblock4

LOG="echo INIT"

# make symlink for kcore
if [ -f /proc/kcore ]; then
    ln -sf /proc/kcore /dev/core
fi

# mount tmpfs if present
tmpfs_av=`grep tmpfs -c < /proc/filesystems`
if [ "$tmpfs_av" != "0" ]; then
    # mount /tmp /etc in /var
    mkdir -p /var/tmpfs
    mount -o bind /var/tmpfs /tmp
    # make dir for rwfs and bind it
    mkdir -p /var/rwfs
    mount -o bind /var/rwfs /etc
fi

$LOG "Mount /tmp/rootfs"
mkdir /tmp/rootfs
mount $ROOTDEVICE /tmp/rootfs -o ro

$LOG "Create some persistent nodes in dev."
/etc/rc.d/mkdevs

$LOG "Init RW particion"
bzcat $MTDDEVICE | /bin/tar xf - -C / > /dev/null 2>&1

if [ -f /etc/filesystem.ok ] && [ -f /etc/rc.d/rcS ]; then
    $LOG "RW File system is ok - preparing ..."
  else
    $LOG "File system is clear or poor."
    cp -af /tmp/rootfs/etc/* /etc
    $LOG "Restored. Save after full boot and configure."
    touch /etc/filesystem.ok
fi

$LOG "Umount /tmp/rootfs"
umount -fl /tmp/rootfs
rm -rf /tmp/rootfs

if [ `awk '/MemTotal:/ {print ($2>16384)}' < /proc/meminfo` -eq 1 ]; then
# >16mb
    touch /tmp/is_32ram_dev
else
# <=16mb
    touch /tmp/is_16ram_dev
fi

# include profile variables
. /etc/profile

$LOG "Start init now."
/bin/sh /etc/rc.d/rcS &
