#!/bin/sh

# if app not exist
if [ ! -f /bin/dnsmasq ]; then
    exit 0
fi

LOG="logger -t dnsserver"

start() {
  get_param
    if [ "$dnsPEnabled" = "1" ] && [ -f $cname ]; then
	if [ -f /tmp/is_32ram_dev ]; then
	    EXT_OPT="-c 128 --dns-forward-max=32"
	else
	    EXT_OPT="-c 32 --dns-forward-max=16"
	fi
	$LOG "Starting DNSMASQ"
	/bin/dnsmasq -N $EXT_OPT --all-servers --clear-on-reload --leasefile-ro \
	    -u nobody -g nobody -C "$cname" -r "$fname" -H "$hname" -f &
    fi
}

stop() {
  $LOG "Stopping DNSMASQ"
    killall -q dnsmasq
    dnsmasqpid=`pidof dnsmasq`
    if [ "$dnsmasqpid" != "" ]; then
	# workaround for not clean kill dnsmasq
	killall -q dnsmasq
	sleep 1
	killall -q -SIGKILL dnsmasq
	rm -rf /var/run/dnsmasq.pid > /dev/null 2>&1
    fi
}

get_param() {
    dnsPEnabled=`nvram_get 2860 dnsPEnabled`
    cname="/etc/dnsmasq.conf"
    fname="/etc/resolv.conf"
    hname="/etc/hosts"
    # read for all write by root
    chmod 644 "$cname" > /dev/null 2>&1
    chmod 644 "$fname" > /dev/null 2>&1
    chmod 644 "$hname" > /dev/null 2>&1
}

case "$1" in
        start)
            start
            ;;

        stop)
            stop
            ;;

        restart)
            stop
            start
            ;;

        *)
            echo $"Usage: $0 {start|stop|restart}"
            exit 1
esac
