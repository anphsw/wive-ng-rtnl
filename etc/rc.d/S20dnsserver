#!/bin/sh

#get params
. /etc/scripts/global.sh

LOG="echo DNSSERVER: "

start() {
    get_param
    if [ -f /bin/dnsmasq ] && [ -f /etc/dnsmasq.conf ] && [ "$dnsPEnabled" = "1" ]; then
        $LOG "Starting DNSMASQ: "
	chmod 644 "$cname"
	chmod 644 "$fname"
	chmod 644 "$hname"
    	/bin/dnsmasq -c 100 -N --dns-forward-max=30 --clear-on-reload --leasefile-ro \
	    -u nobody -g nobody -C "$cname" -r "$fname" -H "$hname" -f -I "$wan_if" &
    fi
}

stop() {
    $LOG "Stopping DNSMASQ: "
    killall -q dnsmasq
    sleep 1
    killall -q -9 dnsmasq
    rm -rf /var/run/dnsmasq.pid > /dev/null 2>&1
}

get_param() {
    dnsPEnabled=`nvram_get 2860 dnsPEnabled`
    cname="/etc/dnsmasq.conf"
    fname="/etc/resolv.conf"
    fname="/etc/hosts"
}

case "$1" in
        start)
            start
            ;;

        stop)
            stop
            ;;

        restart)
            stop
            start
            ;;

        *)
            echo $"Usage: $0 {start|stop|restart}"
            exit 1
esac
