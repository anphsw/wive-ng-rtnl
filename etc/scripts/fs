#!/bin/sh

# Modified by N.Leiten and adopted for Wive-firmware, renamed in "fs"
# "flash" is a part of midge - mini distribuition for adm5120 based routers.
# Full rewrite for Wive-RTNL (RT3050/RT3052) by Evgeniy Manachkin.
# Copyright (C) 2004-2005 by Vladislav Moskovets <midge at vlad.org.ua>
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU GPL v2 or later.

TGZfs_size=131072
BLOCKS=2
KEEPMAC=YES
MTDDEVICE=/dev/mtdblock5
CURRCONFIG=/etc/Wireless/RT2860/RT2860.dat
DEFCONFIG=/etc/default/RT2860_default_novlan

get_size(){
  ls -sk $1 |  sed -e "s/ \+/ /g" | cut -d" " -f2
}

usage(){
  echo "Usage: $0 | save | load | restore | nvramreset | regenerate | fullreset" >&2
  echo "____________________________________________________________________________" >&2
  echo " " >&2
  echo "save - Save rwfs to mtd." >&2
  echo "backup_nvram - Save nvram snapshot to rwfs." >&2
  echo "load - Load rwfs from mtd." >&2
  echo "restore - Crash $MTDDEVICE and reboot for restore clean rwfs." >&2
  echo "nvramreset - Nvarm clean and load default config." >&2
  echo "regenerate - Generate new config from current and save to rwfs." >&2
  echo "fullreset - Full reset include rwfs, nvram and mac adress settings." >&2
  echo "____________________________________________________________________________" >&2
 exit 1
}

regenerate(){
  echo "Regenerate configs for wifi and rwfs defaults. Save to $CURRCONFIG"
  echo "#The following line must not be removed." > $CURRCONFIG
  echo "Default" >> $CURRCONFIG
  ralink_init show 2860 >> $CURRCONFIG
}

load(){
  local dst=/ 
  echo "Loading TGZfs"
  zcat $MTDDEVICE | tar xf - -C $dst>>/dev/null
}

save(){
  echo "Save curent date and current time to rwfs"
  regenerate
  date +%Y%m%d%H%M > /etc/compile-date
  echo "Compress config files"
  tmp="/tmp/tgzfs"
  tar cf - /etc | gzip -9 > $tmp
  if [ "$(get_size $tmp)" -lt $(($TGZfs_size/1024)) ]; then
    echo "Write configs to flash"
    dd if=$tmp of=$MTDDEVICE bs=64k count=$BLOCKS conv=sync > /dev/null 2>&1
    echo "Config saved. OK."
  else
    echo "Error: File $tmp too big: $(get_size $tmp)k"
  fi
  rm -f $tmp
}

restore(){
  echo "Clear rwfs and reboot. Please go smoke..."
  dd if=/dev/urandom of=$MTDDEVICE bs=64k count=$BLOCKS
  echo "123456789">$MTDDEVICE 
  echo "Restoring defaults..."
  reboot
}

nvramreset(){
  echo "Clear and load defaults to nvram!"
  if [ "$KEEPMAC" != "NO" ]; then
    #store mac adesses
    MAC=`nvram_get 2860 WAN_MAC_ADDR`
    WMAC=`nvram_get 2860 WLAN_MAC_ADDR`
    LANMAC=`nvram_get 2860 LAN_MAC_ADDR`
    CHECKMAC=`nvram_get 2860 CHECKMAC`
  fi

  #clear nvram and config
  ralink_init clear 2860
  ralink_init renew 2860 $DEFCONFIG

  if [ "$KEEPMAC" != "NO" ]; then
    #restore macs
    nvram_set 2860 LAN_MAC_ADDR $LANMAC
    nvram_set 2860 WLAN_MAC_ADDR $WMAC
    nvram_set 2860 WAN_MAC_ADDR $MAC
    nvram_set 2860 CHECKMAC $CHECKMAC
  else
    nvram_set 2860 CHECKMAC YES
  fi

  #set wive flag
  nvram_set 2860 IS_WIVE YES
}

fullreset(){
  #set reset mac flag
  echo "Reset rwfs and nvram...."
  KEEPMAC=NO
  nvramreset
  restore
}

backup_nvram(){
  mkdir -p /etc/backup
  CURRCONFIG=/etc/backup/nvram_backup.dat
  echo "Store settings to backup file...."
  regenerate
}

load_nvram(){
  echo "Clear nvram and load settings from backup file...."
  ralink_init renew 2860 /etc/backup/nvram_backup.dat
}

main(){
  local cmd="$1"
  [ -z "$cmd" ] && usage
  shift
  case "$cmd" in 
    regenerate)
      regenerate $@
      ;;
    load) 
      load $@ 
      ;;
    save) 
      save $@ 
      ;;
    restore)
      restore $@
      ;;
    nvramreset)
      nvramreset $@
      ;;
    fullreset)
      fullreset $@
      ;;
    backup_nvram)
      backup_nvram $@
      ;;
    load_nvram)
      load_nvram $@
      ;;
    *) 
      usage $@ 
      ;;
  esac
}

main $@
