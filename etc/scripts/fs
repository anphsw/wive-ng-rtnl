#!/bin/sh

# Modified by N.Leiten and adopted for Wive-firmware, renamed in "fs"
# "flash" is a part of midge - mini distribuition for adm5120 based routers.
# Full rewrite for Wive-RTNL (RT3050/RT3052) by Evgeniy Manachkin.
# Copyright (C) 2004-2005 by Vladislav Moskovets <midge at vlad.org.ua>
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU GPL v2 or later.

TGZfs_size=131072
BLOCKS=2
KEEPMAC=YES
MTDRWFS=/dev/mtdblock5
MTD2CFG=/dev/mtdblock1
MTD2FAC=/dev/mtdblock2

BACKUPCGF=/etc/backup/nvram_backup.dat
RWCONFIGS=/etc/Wireless/rf.bin

get_size(){
  ls -sk "$1" | sed -e "s/ \+/ /g" | cut -d" " -f2
}

usage(){
  echo "Usage: $0 | save | load | restore | backup_nvram | nvramreset | burnrf | fullreset | drop_caches |" >&2
  echo "____________________________________________________________________________" >&2
  echo " " >&2
  echo "save - Save rwfs to mtd." >&2
  echo "load - Load rwfs from mtd." >&2
  echo "restore - Crash $MTDRWFS and reboot for restore clean rwfs." >&2
  echo "backup_nvram - Save nvram snapshot to rwfs in $BACKUPCGF" >&2
  echo "nvramreset - Nvarm clean and load default config." >&2
  echo "burnrf - Burn RF config template to $MTD2FAC." >&2
  echo "drop_caches - Full drop disck/block devices caches for free memory." >&2
  echo "fullreset - 1. Full zero write in config,factory and rwfs particions." >&2
  echo "	    2. Reboot device." >&2
  echo "	    3. Write temlate for RF config (Factory) to flash." >&2
  echo "	    4. Load and write default setting (Config) to flash." >&2
  echo "	    5. Generate new macs, keys and others." >&2
  echo "	    6. Generate new mac and flash it." >&2
  echo "____________________________________________________________________________" >&2
 exit 1
}

load(){
  local dst=/ 
  echo "Loading TGZfs"
  bzcat $MTDRWFS | tar xf - -C $dst>>/dev/null
}

save(){
  echo "Save curent date and current time to rwfs"
  sync
  date +%Y%m%d%H%M > /etc/compile-date
  echo "Compress config files"
  tmp="/tmp/tgzfs"
  tar cf - /etc | bzip2 -9 > $tmp
  if [ "$(get_size $tmp)" -lt $(($TGZfs_size/1024)) ]; then
    echo "Write configs to flash"
    dd if=$tmp of=$MTDRWFS bs=64k count=$BLOCKS conv=sync > /dev/null 2>&1
    echo "Config saved. OK."
  else
    echo "Error: File $tmp too big: $(get_size $tmp)k"
  fi
  rm -f $tmp
  drop_caches
}

restore(){
    echo "Clear rwfs and reboot. Please go smoke..."
    dd if=/dev/zero of=$MTDRWFS conv=sync > /dev/null 2>&1
    reboot
}

nvramreset(){
    echo "Load user defaults."
    nvram_default 2860
}

burnrf(){
    echo "Erase wifi factory part $MTD2FAC."
    dd if=/dev/zero of=$MTD2FAC conv=sync bs=64k count=1 > /dev/null 2>&1
    echo "Flash RF defaults."
    dd if=$RWCONFIGS of=$MTD2FAC conv=sync > /dev/null 2>&1
}

fullreset(){
    echo "Stop services and unload modules..."
    killall -q goahead
    killall -q -SIGKILL goahead
    wifi_unload.sh
    echo "Write zero in $MTDRWFS,$MTD2CFG mtd particions." 
    dd if=/dev/zero of=$MTDRWFS conv=sync bs=64k count=$BLOCKS > /dev/null 2>&1
    dd if=/dev/zero of=$MTD2CFG conv=sync bs=8k seek=1 count=7 > /dev/null 2>&1
    burnrf
    drop_caches
    reboot
}

backup_nvram(){
    mkdir -p /etc/backup
    echo "Store settings to backup file...."
    echo "#The following line must not be removed." > "$BACKUPCGF"
    echo "Default" >> "$BACKUPCGF"
    ralink_init show 2860 >> "$BACKUPCGF"
    drop_caches
}

load_nvram(){
    echo "Load settings from backup file...."
    ralink_init renew 2860 "$BACKUPCGF"
}

# free memory
drop_caches(){
    for i in `seq 1 3`; do
        echo $i > /proc/sys/vm/drop_caches
	sync
    done
    echo 0 > /proc/sys/vm/drop_caches
}

main(){
  local cmd="$1"
  [ -z "$cmd" ] && usage
  shift
  case "$cmd" in 
    load) 
      load $@ 
      ;;
    save) 
      save $@ 
      ;;
    restore)
      restore $@
      ;;
    nvramreset)
      nvramreset $@
      ;;
    burnrf)
      burnrf $@
      ;;
    fullreset)
      fullreset $@
      ;;
    backup_nvram)
      backup_nvram $@
      ;;
    load_nvram)
      load_nvram $@
      ;;
    drop_caches)
      drop_caches $@
      ;;
    *) 
      usage $@ 
      ;;
  esac
}

main $@
