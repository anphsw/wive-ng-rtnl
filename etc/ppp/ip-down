#!/bin/sh

LOG="logger -t pppd"

    $LOG "Flush route cache"
    ip route flush cache

    $LOG "Restore mtu/mru"
    MINMTU=`cat /tmp/ppp-mtu`
    iptables -t mangle -D FORWARD -p tcp -o ppp+ --tcp-flags SYN,RST SYN \
                            -m tcpmss --mss $MINMTU:1506 -j TCPMSS --set-mss $MINMTU
    rm -f /tmp/ppp-mtu

    $LOG "Restart need service and rebuild shaper rules"
    service shaper stop
    sleep 5
    #services reinit
    services_restart.sh pppd
    service shaper start

    if [ -f /etc/ppp/ip-down-route-reload ]; then
	chmod 777 /etc/ppp/ip-down-route-reload
	/etc/ppp/ip-down-route-reload
	rm -f /etc/ppp/ip-down-route-reload
    fi

    $LOG "Down is OK"

export PPP_IFACE PPP_TTY PPP_SPEED PPP_LOCAL PPP_REMOTE PPP_IPPARAM
