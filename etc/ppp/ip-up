#!/bin/sh

PPP_IFACE="$1"
PPP_TTY="$2"
PPP_SPEED="$3"
PPP_LOCAL="$4"
PPP_REMOTE="$5"
PPP_IPPARAM="$6"
LOG="logger -t pppd"

    $LOG "Replace DNS from pppd"
    cp -f /etc/resolv.conf /var/tmp/resolv.conf.tmp.$PPP_IFACE
    grep -v -f /etc/resolv.conf /etc/ppp/resolv.conf > /var/tmp/resolv.$PPP_IFACE
    cat /var/tmp/resolv.$PPP_IFACE >> /etc/resolv.conf

    $LOG "Corbiba hack"
    IP_GATEWAY=`route -n | grep ^0.0.0.0 | awk '{print $2}'`
    DEV_GATEWAY=`route -n | grep ^0.0.0.0 | awk '{print $8}'`
    RESTORESTRING=""

    if [ $IP_GATEWAY != "0.0.0.0" ]; then
	if [ $DEV_GATEWAY != "" ]; then
	    RESTORESTRING="ip route replace default dev $DEV_GATEWAY via $IP_GATEWAY"
	    else
	    RESTORESTRING="ip route replace default via $IP_GATEWAY"
	fi
    else
	if [ $DEV_GATEWAY != "" ]; then
	    RESTORESTRING="ip route replace default dev $DEV_GATEWAY"
	    else
	    RESTORESTRING=""
	fi
    fi

    if [ -f /etc/ppp/ip-down-route-reload ]; then
	rm -f /etc/ppp/ip-down-route-reload
    fi
    $LOG "Store old default route to file"
    (
	echo '#!/bin/sh'
	echo 'ip route del default'
	echo "$RESTORESTRING"
    ) > /etc/ppp/ip-down-route-reload

    $LOG "Replace default route to $PPP_IFACE"
    ip route del $PPP_REMOTE
    ip route del default
    ip route replace default dev $PPP_IFACE
    
    $LOG "Calculate min mtu"
    MINMTU=`ip link show up | grep mtu | awk {' print $PPP_REMOTE-28 '} | sort -n -r | tail -n1`

    $LOG "Renew mss rules"
    iptables -t mangle -D FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
    iptables -t mangle -I FORWARD -p tcp -o ppp+ --tcp-flags SYN,RST SYN \
                            -m tcpmss --mss $MINMTU:1506 -j TCPMSS --set-mss $MINMTU
    iptables -t mangle -I FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
    echo $MINMTU > /tmp/ppp-mtu

    $LOG "Restart dns server, dyndns, ntp sync and rebuild shaper rules"
    service shaper stop
    sleep 10
    #services reinit
    services_restart.sh pppd
    service shaper start
    $LOG "All is start OK"

export PPP_IFACE PPP_TTY PPP_SPEED PPP_LOCAL PPP_REMOTE PPP_IPPARAM
