#!/bin/sh

PPP_IFACE="$1"
PPP_TTY="$2"
PPP_SPEED="$3"
PPP_LOCAL="$4"
PPP_REMOTE="$5"
PPP_IPPARAM="$6"
LOG="logger -t pppd"

lan_ip=`nvram_get 2860 lan_ipaddr`                                                                                       
nm=`nvram_get 2860 lan_netmask`     
Lan2Enabled=`nvram_get 2860 Lan2Enabled`                                                                                 
lan2_ipaddr=`nvram_get 2860 lan2_ipaddr`                                                                                 
lan2_netmask=`nvram_get 2860 lan2_netmask`   
NAT=`nvram_get 2860 natEnabled`
OperationMode=`nvram_get 2860 OperationMode`

    $LOG "Replace DNS from pppd"
    cp -f /etc/resolv.conf /var/tmp/resolv.conf.tmp.$PPP_IFACE
    grep -v -f /etc/resolv.conf /etc/ppp/resolv.conf > /var/tmp/resolv.$PPP_IFACE
    cat /var/tmp/resolv.$PPP_IFACE >> /etc/resolv.conf

    $LOG "Modify route table need for buggy nas"

    #Get current dgw
    GWSTRING=`ip route | grep ^default`

    if [ "$GWSTRING" != "" ]; then
        RESTORESTRING="ip route replace $GWSTRING"
        $LOG "Store old default route to file. $GWSTRING "
        rm -f /tmp/ip-down-route-reload
        (
	    echo '#!/bin/sh'
	    echo 'ip route del default'
	    echo "$RESTORESTRING"
	) > /tmp/ip-down-route-reload
	chmod 777 /tmp/ip-down-route-reload
    else
	$LOG "No dgw stored."
	RESTORESTRING=""
	rm -f /tmp/ip-down-route-reload
    fi

    #Remove auto route in VPN
    ip route del $PPP_REMOTE  > /dev/null 2>&1

    $LOG "Replace default route to $PPP_IFACE"
    ip route del default > /dev/null 2>&1
    ip route replace default dev $PPP_IFACE
    
    $LOG "Calculate min mtu"
    MINMTU=`ip link show up | grep mtu | awk {' print $PPP_REMOTE-28 '} | sort -n -r | tail -n1`

    $LOG "Renew mss rules"
    iptables -t mangle -I FORWARD -p tcp -o $PPP_IFACE --tcp-flags SYN,RST SYN \
                            -m tcpmss --mss $MINMTU:1506 -j TCPMSS --set-mss $MINMTU
    iptables -t mangle -I FORWARD -p tcp -i $PPP_IFACE --tcp-flags SYN,RST SYN \
                            -m tcpmss --mss $MINMTU:1506 -j TCPMSS --set-mss $MINMTU
    echo $MINMTU > /tmp/ppp-mtu

    iptables -A FORWARD -o $PPP_IFACE -j ACCEPT
    if [ "$NAT" = "1" ]  && [ "$OperationMode" != "0" ]; then                                                            
        $LOG "Add masqrade rules to $PPP_IFACE interface"                                 
	iptables -t nat -A POSTROUTING -o $PPP_IFACE -s $lan_ip/$nm -j MASQUERADE
	if [ "$Lan2Enabled" = "1" ]; then                            
	    iptables -t nat -A POSTROUTING -o $PPP_IFACE -s $lan2_ipaddr/$lan2_netmask -j MASQUERADE
	fi
    fi

    $LOG "Restart dns server, dyndns, ntp sync and rebuild shaper rules"
    service shaper stop
    sleep 5
    #services reinit
    services_restart.sh pppd
    service shaper start
    $LOG "All is start OK"

export PPP_IFACE PPP_TTY PPP_SPEED PPP_LOCAL PPP_REMOTE PPP_IPPARAM
