#!/bin/sh

DOS2UNIX=NO
FULLREBUILD=NO
VERSIONPKG="1.7.8.RU.`date +%d%m%Y`"

#---Set_env_ROOTDIR_to_current_dir---#
ROOTDIR=`pwd`                                                                                                                               
export ROOTDIR=$ROOTDIR
export FIRMROOT=$ROOTDIR
export LINUXDIR=$ROOTDIR/linux

#----WR-NL---WR-NL(LITE)----#
if [ "$1" = "" ]; then
    #MODE=2T3R
    MODE=2T2R
    #MODE=2T2R-USB
    #MODE=1T1R
else
    MODE=$1
fi

#------------------------------------#
#WR-N for full and WR-NL for ligth HW
if [ "$MODE" = "2T3R" ] ; then
    DEVNAME="Acorp_WR-450N"
elif [ "$MODE" = "2T2R-USB" ]; then
    DEVNAME="Acorp_WR-300NU"
elif [ "$MODE" = "2T2R" ]; then
    DEVNAME="Acorp_WR-300N"
elif [ "$MODE" = "1T1R" ]; then
    DEVNAME="Acorp_WR-150N"
else
    echo "Not support mode."
    exit 1
fi

if [ "$2" = "" ]; then
    SAVE_MEM=""
else
    SAVE_MEM="-savemem"
fi

echo "" > sdk_version.h
echo "#define RT288X_SDK_VERSION \"$DEVNAME-$VERSIONPKG\"" >> sdk_version.h
echo "" >> sdk_version.h
echo "" > version
echo "RT288X_SDK_VERSION = \"$VERSIONPKG\"" >> version
echo "DEVNAME = \"$DEVNAME\"" >> version
echo "VERSIONPKG = \"$VERSIONPKG\"" >> version
echo "" >> version

#for clear all binary
if [ "$FULLREBUILD" = "YES" ] ; then
echo -------------------------------FULL-CLEAR-------------------------------
    ./clear
fi

rm -rfv romfs/*
rm -rfv images/*

mkdir -p etc/Wireless/RT2860

echo --------------------------------COPY-CONFIG-----------------------------
##############################FOR-ALL-DEVICES#########################
cp -fv ./configs/all/config-lib		./lib/.config
#######################################################################
cp -fv ./configs/all/config-cpp		./uClibc++/.config
cp -fv ./configs/all/config-all		.config
#######################################################################
ln -fs vendors/Ralink/RT3052/config.arch config.arch
ln -fs config/autoconf.h autoconf.h
#######################################################################

#################################PER-DEVICES###########################
if [ "$MODE" = "1T1R" ] ; then
    cp -fv ./configs/kernel/config-kernel-1t1r$SAVE_MEM			./linux/.config
    cp -fv ./configs/all/config-config					./config/.config
    cp -fv ./configs/all/config-busybox					./user/busybox/.config
    cp -fv ./configs/defaults/RT2860_default_novlan-1T1R		./etc/default/RT2860_default_novlan
    cp -fv ./configs/defaults/RT2860.dat-1T1R				./etc/Wireless/RT2860/RT2860.dat
    ln -sf RT3050_AP_1T1R_V1_0.bin					./etc/Wireless/rf.bin
elif [ "$MODE" = "2T2R" ] ; then
    cp -fv ./configs/kernel/config-kernel-2t2r$SAVE_MEM			./linux/.config
    cp -fv ./configs/all/config-busybox					./user/busybox/.config
    cp -fv ./configs/all/config-config					./config/.config
    cp -fv ./configs/defaults/RT2860_default_novlan-2T2R		./etc/default/RT2860_default_novlan
    cp -fv ./configs/defaults/RT2860.dat-2T2R				./etc/Wireless/RT2860/RT2860.dat
    ln -sf RT3052_AP_2T2R_V1_1.bin					./etc/Wireless/rf.bin
elif [ "$MODE" = "2T2R-USB" ] ; then
    cp -fv ./configs/kernel/config-kernel-2t2r-USB-IPV6-8M$SAVE_MEM	./linux/.config
    cp -fv ./configs/all/config-busybox-USB-IPV6-8M			./user/busybox/.config
    cp -fv ./configs/all/config-config-USB-IPV6-8M			./config/.config
    cp -fv ./configs/defaults/RT2860_default_novlan-2T2R		./etc/default/RT2860_default_novlan
    cp -fv ./configs/defaults/RT2860.dat-2T2R				./etc/Wireless/RT2860/RT2860.dat
    ln -sf RT3052_AP_2T2R_V1_1.bin					./etc/Wireless/rf.bin
elif [ "$MODE" = "2T3R" ] ; then
    cp -fv ./configs/kernel/config-kernel-2t3r				./linux/.config
    cp -fv ./configs/all/config-busybox					./user/busybox/.config
    cp -fv ./configs/all/config-config					./config/.config
    cp -fv ./configs/defaults/RT2860_default_novlan-2T3R		./etc/default/RT2860_default_novlan
    cp -fv ./configs/defaults/RT2860.dat-2T3R				./etc/Wireless/RT2860/RT2860.dat
    ln -sf RT3662_AP_2T2R_V0_0.bin					./etc/Wireless/rf.bin
else
    echo "Configs not found."
    exit 1
fi

#for wantusoid`s like.
if [ "$DOS2UNIX" = "YES" ] ; then
echo ---------------------------------DOS2UNIX--------------------------------
    find -type f -exec dos2unix -U -b {} \;
fi

echo -------------------------------MAKE-OLDCONFIGS---------------------------
make oldconfig
make dep

echo ---------------------------------MAKE-ALL--------------------------------
make

if [ -f Uboot/uboot.bin ] && [ -f images/zImage.lzma ] ; then
echo -------------------------------MAKE-FULLDUMP-----------------------------
    make -C fulldump
fi

echo -----------------------------------PACK----------------------------------
mv -f images/*.bin "images/$DEVNAME-$MODE$SAVE_MEM.$VERSIONPKG.bin"
zip -r images/$DEVNAME-$MODE$SAVE_MEM.$VERSIONPKG.bin.zip images/*.bin
