#!/bin/sh

DOS2UNIX=NO
FULLREBUILD=NO
VERSIONPKG="1.1.22.RU.`date +%d%m%Y`"

#---Set_env_ROOTDIR_to_current_dir---#
ROOTDIR=`pwd`                                                                                                                               
export ROOTDIR=$ROOTDIR 

#----WR-NL-4M-16M---WR-NL+-4M-32M----#
if [ "$1" = "" ]; then
    MODE=2T2R
    #MODE=1T1R
    #MODE=1T1R-32
else
    MODE=$1
fi

#----acorp--dlink--------------------#
if [ "$2" = "" ]; then
    VENDOR=acorp
    #VENDOR=dlink
    #VENDOR=asus
else
    VENDOR=$2
fi

#------------------------------------#
#WR-N for full and WR-NL for ligth HW
if [ "$MODE" = "2T2R" ]; then
    DEVNAME=WR-N
else
    DEVNAME=WR-NL
fi
echo "" > sdk_version.h
echo "#define RT288X_SDK_VERSION \"$DEVNAME-$VERSIONPKG\"" >> sdk_version.h
echo "" >> sdk_version.h
echo "" > version
echo "RT288X_SDK_VERSION = \"$VERSIONPKG\"" >> version
echo "" >> version

#for clear all binary
if [ "$FULLREBUILD" = "YES" ] ; then
echo -------------------------------FULL-CLEAR-------------------------------
    ./clear
fi

rm -rfv romfs/*
rm -rfv images/*

echo --------------------------------COPY-CONFIG-----------------------------
if [ "$MODE" = "1T1R" ] ; then
    cp -fv ./configs/kernel-$VENDOR/config-kernel-1t1r		./linux/.config
fi
if [ "$MODE" = "1T1R-32" ] ; then
    cp -fv ./configs/kernel-$VENDOR/config-kernel-1t1r-32	./linux/.config
fi
if [ "$MODE" = "2T2R" ] ; then
    cp -fv ./configs/kernel-$VENDOR/config-kernel-2t2r		./linux/.config
fi

#######################################################################
cp -fv ./configs/all/config-config	./config/.config
cp -fv ./configs/all/config-busybox	./user/busybox/.config
cp -fv ./configs/all/config-lib	./lib/.config
#######################################################################
cp -fv ./configs/all/config-cpp		./uClibc++/.config
cp -fv ./configs/all/config-all		.config
#######################################################################
ln -fs vendors/Ralink/RT3052/config.arch config.arch
ln -fs config/autoconf.h autoconf.h
#######################################################################

#for wantusoid`s like.
if [ "$DOS2UNIX" = "YES" ] ; then
echo ---------------------------------DOS2UNIX--------------------------------
    find -type f -exec dos2unix -U -b {} \;
fi

echo -------------------------------MAKE-OLDCONFIGS---------------------------
make oldconfig
make dep

echo ---------------------------------MAKE-ALL--------------------------------
make

echo -----------------------------------PACK----------------------------------
mv -f images/*.bin "images/$VENDOR.$MODE.$VERSIONPKG.bin"
zip -r images/$VENDOR.$MODE.$VERSIONPKG.bin.zip images/*.bin
