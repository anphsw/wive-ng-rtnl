#!/bin/sh

# stop all processes first
killall dms
killall giftd
killall dmathined
killall snarf
killall ctorrent
killall gdc

#if [ "$1" = "stop" ]; then
#	echo "stop rcex"
#	nvram set apps_installed=0
#	exit
#fi

pool=`nvram get apps_pool`
share=`nvram get apps_share`
rundl=`nvram get apps_dl`
rundms=`nvram get apps_dms`
name=`nvram get computer_name`
mymac=`nvram get et0macaddr`
lang=`nvram get language`

# recount apps_caps
# if (nvram_match("apps_dl", "1"))
#    st->Capability|=APPS_CAP_DOWNLOAD;
# if (nvram_match("apps_photo", "1"))
#    st->Capability|=APPS_CAP_WEBSERVER;
# if (nvram_match("apps_photo_page", "1"))
#    st->Capability|=APPS_CAP_PHOTOALBUM;
# if (nvram_match("apps_dms", "1"))
#    st->Capability|=APPS_CAP_DMS;
cap=0
#if [ "${rundl}" = "1" ]; then
#	cap=`expr $cap + 1`
#fi
#if [ "${runph}" = "1" ]; then
#	cap=`expr $cap + 2`
#fi
#if [ "${runphpage}" = "1" ]; then
#	cap=`expr $cap + 4`
#fi
#if [ "${rundms}" = "1" ]; then
#	cap=`expr $cap + 8`
#fi
#nvram set apps_caps=$cap
nvram set apps_caps=9

EXLIB=/tmp/harddisk/part0/apps/lib
EXBIN=/tmp/harddisk/part0/apps/bin
EXUSR=/tmp/harddisk/part0/apps/usr
#EXWWW=/tmp/harddisk/part0/apps/www
EXETC=/tmp/harddisk/part0/apps/etc

#rm -rf /shares/lib
#rm -rf /shares/bin
#rm -rf /shares/usr
#rm -rf /shares/wwwapps
#rm -rf /shares/etc

#ln -s $EXLIB /shares/lib
#ln -s $EXBIN /shares/bin
#ln -s $EXUSR /shares/usr
#ln -s $EXWWW /shares/wwwapps
#ln -s $EXETC /shares/etc

export PATH=$PATH:/shares/bin:/shares/usr/gift-nasoc/bin
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/shares/lib:/shares/usr/gift-nasoc/lib

#if [ "${rundms}" = "1" ]; then
#	dms /shares/DMSRoot ${name} ${mymac} &
#fi

#if [ "${rundl}" = "1" ]; then
	cd ${EXBIN}
	./dmathined /shares/${pool}/${share} 2&> /dev/null
	cp -f /shares/etc/.giFT/giftd.conf.noplugin /shares/etc/.giFT/giftd.conf
	rungshell prepare
	giftd --home-dir=/shares/${pool}/${share}/Download --local-dir=/shares/etc/.giFT --ex=/shares/${pool}/${share} --data-dir=/shares/etc/giFT --plugin-dir=/shares/usr/gift-nasoc/lib/giFT &
#fi

nvram set apps_installed=1
